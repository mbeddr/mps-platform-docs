---
tags:
- internals
- intellij
- plugins
- java_integration
---

When you are using Kotlin to write an MPS plugin, the guidelines for the [IntelliJ Platform SDK](https://plugins.jetbrains.com/docs/intellij/welcome.html) apply.

## Folder Structure

The folder structure should look like this:

<pre>
├── build.gradle.kts
└── src
    └── main
        ├── kotlin
        └── resources
            └── META-INF
                ├── plugin.xml
                └── pluginIcon.svg
</pre>

## build.gradle.kts
  
The file *build.gradle.kts* should look something like this:

```kotlin
plugins {
    id("org.jetbrains.intellij")
    id("org.jetbrains.kotlin.jvm")
}

repositories {
    mavenCentral()
    maven { url = uri("https://projects.itemis.de/nexus/content/repositories/mbeddr") }
}

val intellijVersion = "2021.1"
val mpsVersion = "2021.1.4"
val targetJvm = "11" // the target Java version

version = "$intellijVersion.4"

dependencies {
    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.4.0")
    implementation("org.jetbrains.kotlin:kotlin-reflect:1.4.0")

    compileOnly("com.jetbrains:mps-workbench:$mpsVersion")
    compileOnly("com.jetbrains:mps-core:$mpsVersion")
    compileOnly("com.jetbrains:mps-platform:$mpsVersion")
    compileOnly("com.jetbrains:mps-openapi:$mpsVersion")
    compileOnly("com.jetbrains:mps-editor:$mpsVersion")
    compileOnly("com.jetbrains:mps-editor-api:$mpsVersion")
}

intellij {
    version.set(intellijVersion)
}

java {
    toolchain.languageVersion.set(JavaLanguageVersion.of(11))
}

tasks.withType<org.jetbrains.kotlin.gradle.tasks.KotlinCompile>().configureEach {
    kotlinOptions.jvmTarget = targetJvm
    kotlinOptions.apiVersion = "1.4"
}

tasks.getByName("buildSearchableOptions").enabled = false

```

The Gradle plugin *org.jetbrains.intellij* is needed for the IntelliJ plugin development, *org.jetbrains.kotlin.jvm* is needed for Kotlin support. We also add the itemis repository for the MPS dependencies. The dependency section contains dependencies for Kotlin and MPS. The available MPS dependencies can be found in the group JetBrains on [mvnrepository.com](https://mvnrepository.com/artifact/com.jetbrains). The rest of the code is boilerplate code for setting the right versions.

## plugin.xml

The file [plugin.xml](https://plugins.jetbrains.com/docs/intellij/plugin-configuration-file.html) is the plugin configuration file and is normally automatically generated by the MPS build language.
In this file, you have to register, for example, tool windows, settings, and actions. Have a look at existing [plugin.xml files](https://github.com/JetBrains/MPS/search?q=filename%3Aplugin.xml) to figure out how they work.

Don't forget to add dependencies to the MPS plugins in this file:
```xml
<idea-plugin>
...
<depends>com.intellij.modules.platform</depends>
<depends>com.intellij.modules.mps</depends>
<depends>jetbrains.mps.core</depends>
...
</idea-plugin>
```

## Links to Sections in the Documentation

- [Actions](https://plugins.jetbrains.com/docs/intellij/basic-action-system.html): extend the class *AnAction*
- [Tool window](https://plugins.jetbrains.com/docs/intellij/tool-windows.html#declarative-setup)
- [Preferences](https://plugins.jetbrains.com/docs/intellij/settings.html)
- [Application plugin](https://plugins.jetbrains.com/docs/intellij/plugin-components.html#application-startup)
- [Running tasks once](https://plugins.jetbrains.com/docs/intellij/ide-infrastructure.html#running-tasks-once)
- [Project plugin](https://plugins.jetbrains.com/docs/intellij/plugin-components.html#project-open)

For everything else, have a look at the [extension point and listener list](https://plugins.jetbrains.com/docs/intellij/extension-point-list.html).

## Building the Plugin

When you are ready, you can build the plugin by executing `./gradlew buildPlugin`. All the other tasks are explained on the page [Gradle IntelliJ plugin](https://plugins.jetbrains.com/docs/intellij/tools-gradle-intellij-plugin.html). Now there should be a folder `build/distributions` which contains the zipped plugin that can be installed through the MPS plugin manager.

## Running the Plugin

Open the file `build.gradle.kts` in the `ide-plugin` folder and change the `intellij` block to use a local
path and disable instrumentation of the code, e.g.:
```
intellij {
    localPath.set(PATH_TO_MPS_FOLDER)
    instrumentCode.set(false)
}
```

Then you have to make sure that the system variable `idea.platform.prefix` is set to 'Idea'.
Workaround: create a file with extension .sh or .bat in the bin folder of the MPS installation with the following content: `-Didea.platform.prefix=Idea`.

You can now open MPS with the plugin installed by calling `./gradlew runIde`.